{% extends 'admin/base_site.html' %}
{% load static i18n %}
{% block title %}{% trans 'Django Log Inspector' %} - {{ block.super }}{% endblock %}

{% block breadcrumbs %}
    <div class="breadcrumbs" x-data>
        <a href="{% url 'admin:index' %}">{% trans 'Home' %}</a>
        <a href="{% url 'log_inspector:home' %}">
            {% if custom_title %}
                {{ custom_title }}
            {% else %}
                {% trans 'Django Log Inspector' %}
            {% endif %}
        </a>
        <button
    class="w-8 h-4 rounded-full bg-white flex items-center transition duration-300 focus:outline-none shadow float-right"
    @click="$store.darkMode.toggle(); toggleTheme()">
    <div
        id="switch-toggle"
        class="w-6 h-6 relative rounded-full transition duration-500 transform bg-yellow-500 -translate-x-1 p-1 text-white">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
        </svg>
    </div>
</button>
    </div>
{% endblock %}

{% block dark-mode-vars %}
{% endblock %}

{% block extrastyle %}
    {{ block.super }}
    <link rel="stylesheet" type="text/css" href="{% static 'log_inspector/css/output.css' %}">

    {% if custom_style_file %}
        <link type="text/css" href="{{ custom_style_file }}" rel="stylesheet">
    {% endif %}
{% endblock %}

{% block extrahead %}
    {{ block.super }}
    <script src="{% static 'log_inspector/js/htmx.min.js' %}" defer></script>
    <script src="{% static 'log_inspector/js/alpinejs.min.js' %}" defer></script>
    <script src="https://kit.fontawesome.com/7773a61110.js" crossorigin="anonymous"></script>
{% endblock %}

{% block content %}
    <div x-data="{ live: false, isFileSelected: false }" class="p-4 mx-auto">
        <div class="flex">
            <div class="flex-none w-9/12 bg-white shadow-md p-6">
                <div class="mb-6">
                    <h1 id="log-entries-title"
                        class="text-3xl font-bold">
                        {% trans 'Django Log Inspector' %}
                    </h1>
                </div>

                <div class="space-x-2">
                    <button id="live-button"
                            class="bg-blue-500 text-white px-4 py-2 rounded"
                            hx-target="#log-entries-table"
                            hx-trigger="click"
                            hx-swap="outerHTML"
                            @click="live = !live"
                            x-show="!live && isFileSelected">
                        {% trans 'Live' %}
                    </button>
                    <button id="stop-button"
                            class="bg-red-500 text-white px-4 py-2 rounded"
                            hx-target="#log-entries-table"
                            hx-trigger="click"
                            hx-swap="outerHTML"
                            @click="live = !live"
                            x-show="live && isFileSelected">
                        {% trans 'Stop' %}
                    </button>
                    <a id="download-link">
                        <button id="download-button"
                                class="bg-green-500 text-white px-4 py-2 rounded"
                                x-show="isFileSelected">
                            {% trans 'Download' %}
                        </button>
                    </a>
                    <input id="search-box"
                           class="py-2 px-4 mt-1 border-2 border-gray-300 rounded-md focus:outline-none
                            focus:border-blue-500 transition duration-300 box-border h-10 w-40 float-right"
                           type="search"
                           name="search"
                           placeholder="{% trans 'Search...' %}"
                           hx-target="#log-entries-table"
                           hx-trigger="input changed delay:300ms, search"
                           hx-swap="outerHTML"
                           x-show="!live && isFileSelected">
                </div>

                <table id="log-entries-table"
                       class="mt-6 w-full border-collapse">
                    <thead>
                    <tr>
                        <th scope="col" class="border p-2">{% trans 'No.' %}</th>
                        <th scope="col" class="border p-2">{% trans 'Log entries' %}</th>
                    </tr>
                    </thead>
                    <tbody id="log-entries-data">
                    <tr>
                        <td colspan="2" class="border p-2">{% trans 'No entries!' %}</td>
                    </tr>
                    </tbody>

                    <tfoot id="log-entries-footer">
                    <tfoot/>
                </table>
            </div>

            <div class="flex-none w-3/12 ml-6 bg-white shadow-md p-6">
                <h2 class="pl-1 pr-2 py-3 text-2xl font-bold">{% trans 'Log Files' %}</h2>
                <input class="w-full py-2 px-4 border-2 border-gray-300 rounded-md focus:outline-none
                              focus:border-blue-500 transition duration-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                       type="search"
                       name="search"
                       placeholder="{% trans 'Search...' %}"
                       hx-get="{% url 'log_inspector:log_files' %}"
                       hx-trigger="input changed delay:300ms, search"
                       hx-target="#log-files-data"
                       hx-swap="outerHTML">

                <table id="log-files-table"
                       class="w-full border-collapse mt-2"
                       hx-get="{% url 'log_inspector:log_files' %}"
                       hx-trigger="load"
                       hx-target="#log-files-data"
                       hx-swap="outerHTML">
                    <tbody id="log-files-data">
                    <tr>
                        <td colspan="2" class="border p-2 w-full">{% trans 'No entries!' %}</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.store('darkMode', {
                on: window.matchMedia('(prefers-color-scheme: dark)').matches,

                init() {
                    document.documentElement.classList.toggle('dark', this.on);
                },

                toggle() {
                    this.on = !this.on;
                    document.documentElement.classList.toggle('dark', this.on);
                }
            })
        })

        function updateFileName(event) {
            const td = event.target;
            const fileName = td.textContent.trim();

            const liveButton = document.getElementById('live-button');
            const stopButton = document.getElementById('stop-button');
            const searchBox = document.getElementById('search-box');
            const downloadLink = document.getElementById('download-link');
            const logEntriesTitle = document.getElementById('log-entries-title')
            liveButton.setAttribute('hx-get', `/logs/start-live/${fileName}/`)
            stopButton.setAttribute('hx-get', `/logs/stop-live/${fileName}/`)
            searchBox.setAttribute('hx-get', `/logs/log-entries/${fileName}/`)
            downloadLink.setAttribute('href', `/logs/download/${fileName}/`)
            logEntriesTitle.innerText = fileName

            htmx.process(document.body)
        }

        function copyText(event) {
            const logEntryDiv = event.target.parentNode.previousElementSibling
            const textToCopy = logEntryDiv.textContent.trim();

            navigator.clipboard.writeText(textToCopy);

            Alpine.store('copiedValue', textToCopy);
        }

        const switchToggle = document.querySelector('#switch-toggle');
        let isDarkmode = false

        const darkIcon = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
</svg>`

        const lightIcon = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
</svg>`

        function toggleTheme() {
            isDarkmode = !isDarkmode
            localStorage.setItem('isDarkmode', isDarkmode)
            switchTheme()
        }

        function switchTheme() {
            if (isDarkmode) {
                switchToggle.classList.remove('bg-yellow-500', '-translate-x-2')
                switchToggle.classList.add('bg-gray-700', 'translate-x-full')
                setTimeout(() => {
                    switchToggle.innerHTML = darkIcon
                }, 250);
            } else {
                switchToggle.classList.add('bg-yellow-500', '-translate-x-2')
                switchToggle.classList.remove('bg-gray-700', 'translate-x-full')
                setTimeout(() => {
                    switchToggle.innerHTML = lightIcon
                }, 250);
            }
        }

        switchTheme()
    </script>
{% endblock %}